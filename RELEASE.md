# Release Process

## 1) Verify quality gate

```bash
pnpm install
pnpm gate
pnpm mcp:build
pnpm -C packages/mcp test -- contract.test.ts
pnpm -C packages/mcp motionforge make-bundle --in apps/web/public/demo/motionforge-takes-demo.json --goal "idle loop then recoil" --out .motionforge/release-preview
pnpm -C packages/mcp motionforge make-bundle --in apps/web/public/demo/motionforge-takes-demo.json --goal "idle loop then recoil" --out .motionforge/release-apply --confirm
```

## 2) Build production web app

```bash
pnpm -C apps/web build
```

Output: `apps/web/dist`

## 2b) Agent runner smoke proof

Before tagging a release, run the deterministic agent runner smoke:

```bash
pnpm -C apps/web test -- scriptRunner.test.ts agentApi.test.ts skills.test.ts
```

Expected:
- all tests pass
- no WebGL dependency required for these tests
- staged runner restores baseline state on failure paths

## 2c) MCP smoke proof

Run one-command MCP sanity in a second terminal:

```bash
pnpm mcp:dev
```

Then verify tool listing/ping using MCP client (or contract test):

```bash
pnpm -C packages/mcp test -- contract.test.ts
```

Expected:
- stdio transport starts cleanly
- `mf.ping` responds
- staged load/commit contract tests pass

## 3) Deploy

- GitHub Pages deploys automatically on `main` via:
  - `.github/workflows/deploy-pages.yml`
- Base path for Pages is configured through `VITE_BASE_PATH` in that workflow.

## 4) Tag release

```bash
git tag vX.Y.Z
git push origin vX.Y.Z
```

Tag workflow `.github/workflows/release-artifact.yml` will:

1. Install dependencies
2. Validate semver tag format (`vX.Y.Z`)
3. Run `pnpm gate`
4. Build web app
5. Generate `apps/web/dist/version-metadata.json`
6. Generate `apps/web/dist/build-manifest.json` (hashes + metadata)
7. Upload release artifacts
8. Create a GitHub Release with templated notes and autogenerated commit notes

## 5) Release artifacts

- `motionforge-web-vX.Y.Z.zip`: full `apps/web/dist` static build
- `version-metadata-vX.Y.Z.json`:
  - tag
  - commit
  - build timestamp
- `build-manifest-vX.Y.Z.json`:
  - build metadata
  - dist file paths
  - per-file size and SHA-256 hash

## 6) Verify workflow updates

- Validate workflow syntax in GitHub Actions editor.
- Optional local dry run (if available):

```bash
act -n -W .github/workflows/release-artifact.yml
```

- Confirm release contains all three artifacts and release notes.

## 7) Publishing policy

- No npm publish step is part of this release process.
- MotionForge releases are web artifacts only.
